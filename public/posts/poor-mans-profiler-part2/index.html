<!DOCTYPE html>
<html lang="zh">

<head>
  <title>
  è‡ªåˆ¶ Profiler ç¬¬äºŒéƒ¨åˆ†â€”â€”è°ƒç”¨æ ˆå›æº¯ Â· Think in Hualet
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Hualet Wang">
<meta name="description" content="ä¹¦æ¥ä¸Šç¯‡ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½åœ¨å…¶ä»–ç¨‹åºä¸­æ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œå¹¶ä¸”ä¹Ÿåšåˆ°äº†ä»¥å›ºå®šçš„é¢‘ç‡å»æ‰§è¡Œé‡‡æ ·ä»£ç ï¼ˆæˆ‘ä»¬çš„printfï¼‰ï¼Œä½†æ˜¯å¦‚ä½•é‡‡æ ·è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« ä¼šå°±è¿™è¿™ä¸ªé—®é¢˜ç»§ç»­æ¢è®¨æ¥ä¸‹å»æˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜â€”â€”è°ƒç”¨æ ˆå›æº¯ã€‚
ä¸ºä»€ä¹ˆè¦è·å–å‡½æ•°è°ƒç”¨æ ˆï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸ºprofileré™¤äº†è¦åˆ†æç¨‹åºå­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå³å‡½æ•°æ‰§è¡Œçƒ­ç‚¹ä»¥å¤–ï¼Œè¿˜éœ€è¦å¸®åŠ©æˆ‘ä»¬å¯æ€œçš„ç¨‹åºå‘˜æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œè¿™æ—¶å€™èƒ½æä¾›é—®é¢˜å‡½æ•°çš„å †æ ˆä¿¡æ¯å°±éå¸¸å¿…è¦äº†ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« å…¶å®è¯´äº†ï¼Œæ˜¯ä¸ºäº†é€šè¿‡å †æ ˆä¿¡æ¯å°½é‡è¿˜åŸç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼šè¯•æƒ³ä¸€ä¸ªç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ main-&gt;funca-&gt;funcb-&gt;funccï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡é‡‡æ · main-&gt;funcaï¼Œç¬¬äºŒæ¬¡é‡‡æ · main-&gt;funca-&gt;funcb-&gt;funccï¼Œå‡å¦‚æˆ‘ä»¬æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡ä¸€æ¬¡ funca å’Œä¸€æ¬¡funccï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ååº”äº‹å®ï¼Œç›¸åï¼Œæˆ‘ä»¬æœ‰å †æ ˆä¿¡æ¯çš„è¯ï¼Œå°±ä¼šæŠŠ funca ã€funcb å’Œ funcc å„è®¡æ•°ä¸€æ¬¡ï¼Œæ›´èƒ½ååº”å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

  æ¦‚å¿µ
  
    
    Link to heading
  

å‡½æ•°è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰å’Œç›¸åº”çš„æ ˆå¸§ï¼ˆStack Frameï¼‰æˆ‘ä»¬å…¶å®éƒ½ä¸é™Œç”Ÿï¼šåœ¨ä½¿ç”¨ gdb è°ƒè¯•ç¨‹åºçš„æ—¶å€™ï¼Œbtï¼ˆbacktraceï¼‰å‘½ä»¤æ‰“å°å‡ºæ¥çš„å°±æ˜¯å‡½æ•°è°ƒç”¨æ ˆï¼›è€Œå‡½æ•°è°ƒç”¨æ ˆåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹åˆ™ä»£è¡¨ä¸€ä¸ªæ ˆå¸§ï¼Œæˆ‘ä»¬æ‰§è¡Œ frame å‘½ä»¤è·³è½¬åˆ°æŸä¸€ä¸ªæ ˆå¸§ï¼Œå…¶å®å°±æ˜¯ä¸€æ¬¡å›æº¯çš„è¿‡ç¨‹ã€‚
æƒ³è¦åœ¨å†…å­˜ä¸­è§£æå‡ºæˆ‘ä»¬æƒ³è¦çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ä¸€ä¸ªç¨‹åºçš„stack æ®µé‡Œé¢å„ä¸ªæ ˆå¸§æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¦ææ¸…æ¥šè¿™ä¸ªï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸ªæ¦‚å¿µå«ï¼šè°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰ï¼Œè°ƒç”¨çº¦å®šä¸»è¦çº¦å®šäº†ï¼ˆå¥½ç»•ï¼‰ï¼š

å‡½æ•°çš„å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Œæ˜¯å…¨éƒ½æ”¾åˆ°å¯„å­˜å™¨ï¼Œè¿˜æ˜¯å…¨éƒ½æ”¾åœ¨ stack æ®µï¼Œè¿˜æ˜¯æ··ç”¨ä¸¤è€…ï¼›
å‡½æ•°çš„å‚æ•°æ˜¯æŒ‰ä»€ä¹ˆé¡ºåºæ”¾ç½®åˆ°å†…å­˜ä¸­çš„ï¼›
å‡½æ•°ä¸­çš„æœ¬åœ°å˜é‡æ˜¯å¦‚ä½•åˆ†é…çš„ï¼›
å­å‡½æ•°è°ƒç”¨æ˜¯å¦‚ä½•è¿”å›çš„ï¼›
å­å‡½æ•°çš„æ ˆå¸§æ˜¯å¦‚ä½•æ¸…ç†çš„ï¼›
ç­‰ç­‰

æ‰€ä»¥ï¼Œè°ƒç”¨çº¦å®šåŸºæœ¬ä¸Šå†³å®šäº†å‡½æ•°è°ƒç”¨ä¸­æ¯ä¸ªæ ˆå¸§çš„äº§ç”Ÿã€å‹æ ˆã€å‡ºæ ˆå¯¹å†…å­˜å¸ƒå±€çš„å½±å“ï¼Œè€Œè¿™ä¸ªçº¦å®šæ˜¯å› æ¶æ„å’Œå¹³å°è€Œå¼‚çš„ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨x86 å¹³å°ä¸‹çš„ cdecl çº¦å®šã€‚
åœ¨è¿™ä¸ªçº¦å®šä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° DrawSqure è°ƒç”¨äº† DrawLine ï¼ˆä¾‹å­æ¥è‡ªWikipediaï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå†…å­˜å¸ƒå±€ä¸­çš„ stack æ®µå°±åº”è¯¥æ˜¯ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š

æ¯ä¸ªå‡½æ•°è°ƒç”¨å³åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§ä¸€æ¬¡å‹å…¥ stack ä¸­ã€‚
å…¶ä¸­ï¼ŒStack Pointer(esp) æ°¸è¿œæŒ‡å‘æ ˆé¡¶ï¼Œ Frame Pointer(ebp) æŒ‡å‘å½“å‰æ ˆå¸§çš„ä¸­ä¸€ä¸ªå›ºå®šçš„åœ°æ–¹ï¼ˆåŸºåœ°å€ï¼‰ï¼›å‡½æ•°å‚æ•°ä»¥ä»å³å¾€å·¦çš„é¡ºåºä¾æ¬¡å‹æ ˆï¼Œç„¶åæ˜¯å‹å…¥Return Address ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°ï¼ˆæˆ–è€…æ ˆå¸§ï¼‰æ‰§è¡Œå®Œæˆåï¼Œç¨‹åºè¦ç»§ç»­æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œ åŒæ—¶å‹å…¥çˆ¶å‡½æ•°çš„æ ˆå¸§åŸºåœ°å€ï¼ˆSaved EBPï¼‰ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åï¼ŒStack Pointer å’Œ Frame Pointer å°†ä¼šæŒ‡å‘çš„åœ°æ–¹ï¼ŒåŸºäºè¿™ä¸ªåœ°å€ï¼Œç¨‹åºæŒ‡ä»¤å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å‡½æ•°æœ¬åœ°å˜é‡ï¼ˆebpè´Ÿå‘åç§»ï¼‰å’Œå‡½æ•°å‚æ•°ï¼ˆebpæ­£å‘åç§»ï¼‰ã€‚
">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="è‡ªåˆ¶ Profiler ç¬¬äºŒéƒ¨åˆ†â€”â€”è°ƒç”¨æ ˆå›æº¯">
  <meta name="twitter:description" content="ä¹¦æ¥ä¸Šç¯‡ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½åœ¨å…¶ä»–ç¨‹åºä¸­æ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œå¹¶ä¸”ä¹Ÿåšåˆ°äº†ä»¥å›ºå®šçš„é¢‘ç‡å»æ‰§è¡Œé‡‡æ ·ä»£ç ï¼ˆæˆ‘ä»¬çš„printfï¼‰ï¼Œä½†æ˜¯å¦‚ä½•é‡‡æ ·è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« ä¼šå°±è¿™è¿™ä¸ªé—®é¢˜ç»§ç»­æ¢è®¨æ¥ä¸‹å»æˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜â€”â€”è°ƒç”¨æ ˆå›æº¯ã€‚
ä¸ºä»€ä¹ˆè¦è·å–å‡½æ•°è°ƒç”¨æ ˆï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸ºprofileré™¤äº†è¦åˆ†æç¨‹åºå­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå³å‡½æ•°æ‰§è¡Œçƒ­ç‚¹ä»¥å¤–ï¼Œè¿˜éœ€è¦å¸®åŠ©æˆ‘ä»¬å¯æ€œçš„ç¨‹åºå‘˜æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œè¿™æ—¶å€™èƒ½æä¾›é—®é¢˜å‡½æ•°çš„å †æ ˆä¿¡æ¯å°±éå¸¸å¿…è¦äº†ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« å…¶å®è¯´äº†ï¼Œæ˜¯ä¸ºäº†é€šè¿‡å †æ ˆä¿¡æ¯å°½é‡è¿˜åŸç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼šè¯•æƒ³ä¸€ä¸ªç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ main-&gt;funca-&gt;funcb-&gt;funccï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡é‡‡æ · main-&gt;funcaï¼Œç¬¬äºŒæ¬¡é‡‡æ · main-&gt;funca-&gt;funcb-&gt;funccï¼Œå‡å¦‚æˆ‘ä»¬æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡ä¸€æ¬¡ funca å’Œä¸€æ¬¡funccï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ååº”äº‹å®ï¼Œç›¸åï¼Œæˆ‘ä»¬æœ‰å †æ ˆä¿¡æ¯çš„è¯ï¼Œå°±ä¼šæŠŠ funca ã€funcb å’Œ funcc å„è®¡æ•°ä¸€æ¬¡ï¼Œæ›´èƒ½ååº”å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ã€‚
æ¦‚å¿µ Link to heading å‡½æ•°è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰å’Œç›¸åº”çš„æ ˆå¸§ï¼ˆStack Frameï¼‰æˆ‘ä»¬å…¶å®éƒ½ä¸é™Œç”Ÿï¼šåœ¨ä½¿ç”¨ gdb è°ƒè¯•ç¨‹åºçš„æ—¶å€™ï¼Œbtï¼ˆbacktraceï¼‰å‘½ä»¤æ‰“å°å‡ºæ¥çš„å°±æ˜¯å‡½æ•°è°ƒç”¨æ ˆï¼›è€Œå‡½æ•°è°ƒç”¨æ ˆåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹åˆ™ä»£è¡¨ä¸€ä¸ªæ ˆå¸§ï¼Œæˆ‘ä»¬æ‰§è¡Œ frame å‘½ä»¤è·³è½¬åˆ°æŸä¸€ä¸ªæ ˆå¸§ï¼Œå…¶å®å°±æ˜¯ä¸€æ¬¡å›æº¯çš„è¿‡ç¨‹ã€‚
æƒ³è¦åœ¨å†…å­˜ä¸­è§£æå‡ºæˆ‘ä»¬æƒ³è¦çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ä¸€ä¸ªç¨‹åºçš„stack æ®µé‡Œé¢å„ä¸ªæ ˆå¸§æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¦ææ¸…æ¥šè¿™ä¸ªï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸ªæ¦‚å¿µå«ï¼šè°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰ï¼Œè°ƒç”¨çº¦å®šä¸»è¦çº¦å®šäº†ï¼ˆå¥½ç»•ï¼‰ï¼š
å‡½æ•°çš„å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Œæ˜¯å…¨éƒ½æ”¾åˆ°å¯„å­˜å™¨ï¼Œè¿˜æ˜¯å…¨éƒ½æ”¾åœ¨ stack æ®µï¼Œè¿˜æ˜¯æ··ç”¨ä¸¤è€…ï¼› å‡½æ•°çš„å‚æ•°æ˜¯æŒ‰ä»€ä¹ˆé¡ºåºæ”¾ç½®åˆ°å†…å­˜ä¸­çš„ï¼› å‡½æ•°ä¸­çš„æœ¬åœ°å˜é‡æ˜¯å¦‚ä½•åˆ†é…çš„ï¼› å­å‡½æ•°è°ƒç”¨æ˜¯å¦‚ä½•è¿”å›çš„ï¼› å­å‡½æ•°çš„æ ˆå¸§æ˜¯å¦‚ä½•æ¸…ç†çš„ï¼› ç­‰ç­‰ æ‰€ä»¥ï¼Œè°ƒç”¨çº¦å®šåŸºæœ¬ä¸Šå†³å®šäº†å‡½æ•°è°ƒç”¨ä¸­æ¯ä¸ªæ ˆå¸§çš„äº§ç”Ÿã€å‹æ ˆã€å‡ºæ ˆå¯¹å†…å­˜å¸ƒå±€çš„å½±å“ï¼Œè€Œè¿™ä¸ªçº¦å®šæ˜¯å› æ¶æ„å’Œå¹³å°è€Œå¼‚çš„ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨x86 å¹³å°ä¸‹çš„ cdecl çº¦å®šã€‚
åœ¨è¿™ä¸ªçº¦å®šä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° DrawSqure è°ƒç”¨äº† DrawLine ï¼ˆä¾‹å­æ¥è‡ªWikipediaï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå†…å­˜å¸ƒå±€ä¸­çš„ stack æ®µå°±åº”è¯¥æ˜¯ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š
æ¯ä¸ªå‡½æ•°è°ƒç”¨å³åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§ä¸€æ¬¡å‹å…¥ stack ä¸­ã€‚
å…¶ä¸­ï¼ŒStack Pointer(esp) æ°¸è¿œæŒ‡å‘æ ˆé¡¶ï¼Œ Frame Pointer(ebp) æŒ‡å‘å½“å‰æ ˆå¸§çš„ä¸­ä¸€ä¸ªå›ºå®šçš„åœ°æ–¹ï¼ˆåŸºåœ°å€ï¼‰ï¼›å‡½æ•°å‚æ•°ä»¥ä»å³å¾€å·¦çš„é¡ºåºä¾æ¬¡å‹æ ˆï¼Œç„¶åæ˜¯å‹å…¥Return Address ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°ï¼ˆæˆ–è€…æ ˆå¸§ï¼‰æ‰§è¡Œå®Œæˆåï¼Œç¨‹åºè¦ç»§ç»­æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œ åŒæ—¶å‹å…¥çˆ¶å‡½æ•°çš„æ ˆå¸§åŸºåœ°å€ï¼ˆSaved EBPï¼‰ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åï¼ŒStack Pointer å’Œ Frame Pointer å°†ä¼šæŒ‡å‘çš„åœ°æ–¹ï¼ŒåŸºäºè¿™ä¸ªåœ°å€ï¼Œç¨‹åºæŒ‡ä»¤å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å‡½æ•°æœ¬åœ°å˜é‡ï¼ˆebpè´Ÿå‘åç§»ï¼‰å’Œå‡½æ•°å‚æ•°ï¼ˆebpæ­£å‘åç§»ï¼‰ã€‚">

<meta property="og:url" content="https://www.hualet.org/posts/poor-mans-profiler-part2/">
  <meta property="og:site_name" content="Think in Hualet">
  <meta property="og:title" content="è‡ªåˆ¶ Profiler ç¬¬äºŒéƒ¨åˆ†â€”â€”è°ƒç”¨æ ˆå›æº¯">
  <meta property="og:description" content="ä¹¦æ¥ä¸Šç¯‡ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½åœ¨å…¶ä»–ç¨‹åºä¸­æ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œå¹¶ä¸”ä¹Ÿåšåˆ°äº†ä»¥å›ºå®šçš„é¢‘ç‡å»æ‰§è¡Œé‡‡æ ·ä»£ç ï¼ˆæˆ‘ä»¬çš„printfï¼‰ï¼Œä½†æ˜¯å¦‚ä½•é‡‡æ ·è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« ä¼šå°±è¿™è¿™ä¸ªé—®é¢˜ç»§ç»­æ¢è®¨æ¥ä¸‹å»æˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜â€”â€”è°ƒç”¨æ ˆå›æº¯ã€‚
ä¸ºä»€ä¹ˆè¦è·å–å‡½æ•°è°ƒç”¨æ ˆï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸ºprofileré™¤äº†è¦åˆ†æç¨‹åºå­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå³å‡½æ•°æ‰§è¡Œçƒ­ç‚¹ä»¥å¤–ï¼Œè¿˜éœ€è¦å¸®åŠ©æˆ‘ä»¬å¯æ€œçš„ç¨‹åºå‘˜æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œè¿™æ—¶å€™èƒ½æä¾›é—®é¢˜å‡½æ•°çš„å †æ ˆä¿¡æ¯å°±éå¸¸å¿…è¦äº†ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« å…¶å®è¯´äº†ï¼Œæ˜¯ä¸ºäº†é€šè¿‡å †æ ˆä¿¡æ¯å°½é‡è¿˜åŸç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼šè¯•æƒ³ä¸€ä¸ªç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ main-&gt;funca-&gt;funcb-&gt;funccï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡é‡‡æ · main-&gt;funcaï¼Œç¬¬äºŒæ¬¡é‡‡æ · main-&gt;funca-&gt;funcb-&gt;funccï¼Œå‡å¦‚æˆ‘ä»¬æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡ä¸€æ¬¡ funca å’Œä¸€æ¬¡funccï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ååº”äº‹å®ï¼Œç›¸åï¼Œæˆ‘ä»¬æœ‰å †æ ˆä¿¡æ¯çš„è¯ï¼Œå°±ä¼šæŠŠ funca ã€funcb å’Œ funcc å„è®¡æ•°ä¸€æ¬¡ï¼Œæ›´èƒ½ååº”å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ã€‚
æ¦‚å¿µ Link to heading å‡½æ•°è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰å’Œç›¸åº”çš„æ ˆå¸§ï¼ˆStack Frameï¼‰æˆ‘ä»¬å…¶å®éƒ½ä¸é™Œç”Ÿï¼šåœ¨ä½¿ç”¨ gdb è°ƒè¯•ç¨‹åºçš„æ—¶å€™ï¼Œbtï¼ˆbacktraceï¼‰å‘½ä»¤æ‰“å°å‡ºæ¥çš„å°±æ˜¯å‡½æ•°è°ƒç”¨æ ˆï¼›è€Œå‡½æ•°è°ƒç”¨æ ˆåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹åˆ™ä»£è¡¨ä¸€ä¸ªæ ˆå¸§ï¼Œæˆ‘ä»¬æ‰§è¡Œ frame å‘½ä»¤è·³è½¬åˆ°æŸä¸€ä¸ªæ ˆå¸§ï¼Œå…¶å®å°±æ˜¯ä¸€æ¬¡å›æº¯çš„è¿‡ç¨‹ã€‚
æƒ³è¦åœ¨å†…å­˜ä¸­è§£æå‡ºæˆ‘ä»¬æƒ³è¦çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ä¸€ä¸ªç¨‹åºçš„stack æ®µé‡Œé¢å„ä¸ªæ ˆå¸§æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¦ææ¸…æ¥šè¿™ä¸ªï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸ªæ¦‚å¿µå«ï¼šè°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰ï¼Œè°ƒç”¨çº¦å®šä¸»è¦çº¦å®šäº†ï¼ˆå¥½ç»•ï¼‰ï¼š
å‡½æ•°çš„å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Œæ˜¯å…¨éƒ½æ”¾åˆ°å¯„å­˜å™¨ï¼Œè¿˜æ˜¯å…¨éƒ½æ”¾åœ¨ stack æ®µï¼Œè¿˜æ˜¯æ··ç”¨ä¸¤è€…ï¼› å‡½æ•°çš„å‚æ•°æ˜¯æŒ‰ä»€ä¹ˆé¡ºåºæ”¾ç½®åˆ°å†…å­˜ä¸­çš„ï¼› å‡½æ•°ä¸­çš„æœ¬åœ°å˜é‡æ˜¯å¦‚ä½•åˆ†é…çš„ï¼› å­å‡½æ•°è°ƒç”¨æ˜¯å¦‚ä½•è¿”å›çš„ï¼› å­å‡½æ•°çš„æ ˆå¸§æ˜¯å¦‚ä½•æ¸…ç†çš„ï¼› ç­‰ç­‰ æ‰€ä»¥ï¼Œè°ƒç”¨çº¦å®šåŸºæœ¬ä¸Šå†³å®šäº†å‡½æ•°è°ƒç”¨ä¸­æ¯ä¸ªæ ˆå¸§çš„äº§ç”Ÿã€å‹æ ˆã€å‡ºæ ˆå¯¹å†…å­˜å¸ƒå±€çš„å½±å“ï¼Œè€Œè¿™ä¸ªçº¦å®šæ˜¯å› æ¶æ„å’Œå¹³å°è€Œå¼‚çš„ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨x86 å¹³å°ä¸‹çš„ cdecl çº¦å®šã€‚
åœ¨è¿™ä¸ªçº¦å®šä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° DrawSqure è°ƒç”¨äº† DrawLine ï¼ˆä¾‹å­æ¥è‡ªWikipediaï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå†…å­˜å¸ƒå±€ä¸­çš„ stack æ®µå°±åº”è¯¥æ˜¯ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š
æ¯ä¸ªå‡½æ•°è°ƒç”¨å³åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§ä¸€æ¬¡å‹å…¥ stack ä¸­ã€‚
å…¶ä¸­ï¼ŒStack Pointer(esp) æ°¸è¿œæŒ‡å‘æ ˆé¡¶ï¼Œ Frame Pointer(ebp) æŒ‡å‘å½“å‰æ ˆå¸§çš„ä¸­ä¸€ä¸ªå›ºå®šçš„åœ°æ–¹ï¼ˆåŸºåœ°å€ï¼‰ï¼›å‡½æ•°å‚æ•°ä»¥ä»å³å¾€å·¦çš„é¡ºåºä¾æ¬¡å‹æ ˆï¼Œç„¶åæ˜¯å‹å…¥Return Address ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°ï¼ˆæˆ–è€…æ ˆå¸§ï¼‰æ‰§è¡Œå®Œæˆåï¼Œç¨‹åºè¦ç»§ç»­æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œ åŒæ—¶å‹å…¥çˆ¶å‡½æ•°çš„æ ˆå¸§åŸºåœ°å€ï¼ˆSaved EBPï¼‰ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åï¼ŒStack Pointer å’Œ Frame Pointer å°†ä¼šæŒ‡å‘çš„åœ°æ–¹ï¼ŒåŸºäºè¿™ä¸ªåœ°å€ï¼Œç¨‹åºæŒ‡ä»¤å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å‡½æ•°æœ¬åœ°å˜é‡ï¼ˆebpè´Ÿå‘åç§»ï¼‰å’Œå‡½æ•°å‚æ•°ï¼ˆebpæ­£å‘åç§»ï¼‰ã€‚">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-05-14T14:19:37+08:00">
    <meta property="article:modified_time" content="2018-05-14T14:19:37+08:00">




<link rel="canonical" href="https://www.hualet.org/posts/poor-mans-profiler-part2/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css" integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm&#43;MTzNJdv80k&#43;n0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://www.hualet.org/">
      Think in Hualet
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">åšå®¢</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/blogroll/">å‹é“¾</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">å…³äº</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/en/">ğŸ‡¬ğŸ‡§</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://www.hualet.org/posts/poor-mans-profiler-part2/">
              è‡ªåˆ¶ Profiler ç¬¬äºŒéƒ¨åˆ†â€”â€”è°ƒç”¨æ ˆå›æº¯
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2018-05-14T14:19:37&#43;08:00">
                äº”æœˆ 14, 2018
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>ä¹¦æ¥ä¸Šç¯‡ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»èƒ½åœ¨å…¶ä»–ç¨‹åºä¸­æ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œå¹¶ä¸”ä¹Ÿåšåˆ°äº†ä»¥å›ºå®šçš„é¢‘ç‡å»æ‰§è¡Œé‡‡æ ·ä»£ç ï¼ˆæˆ‘ä»¬çš„<code>printf</code>ï¼‰ï¼Œä½†æ˜¯å¦‚ä½•é‡‡æ ·è¿˜æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« ä¼šå°±è¿™è¿™ä¸ªé—®é¢˜ç»§ç»­æ¢è®¨æ¥ä¸‹å»æˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜â€”â€”è°ƒç”¨æ ˆå›æº¯ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦è·å–å‡½æ•°è°ƒç”¨æ ˆï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸ºprofileré™¤äº†è¦åˆ†æç¨‹åºå­˜åœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œå³å‡½æ•°æ‰§è¡Œçƒ­ç‚¹ä»¥å¤–ï¼Œè¿˜éœ€è¦å¸®åŠ©æˆ‘ä»¬å¯æ€œçš„ç¨‹åºå‘˜æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œè¿™æ—¶å€™èƒ½æä¾›é—®é¢˜å‡½æ•°çš„å †æ ˆä¿¡æ¯å°±éå¸¸å¿…è¦äº†ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« å…¶å®è¯´äº†ï¼Œæ˜¯ä¸ºäº†é€šè¿‡å †æ ˆä¿¡æ¯å°½é‡è¿˜åŸç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ï¼šè¯•æƒ³ä¸€ä¸ªç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ main-&gt;funca-&gt;funcb-&gt;funccï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡é‡‡æ · main-&gt;funcaï¼Œç¬¬äºŒæ¬¡é‡‡æ · main-&gt;funca-&gt;funcb-&gt;funccï¼Œå‡å¦‚æˆ‘ä»¬æ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡ä¸€æ¬¡ funca å’Œä¸€æ¬¡funccï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ååº”äº‹å®ï¼Œç›¸åï¼Œæˆ‘ä»¬æœ‰å †æ ˆä¿¡æ¯çš„è¯ï¼Œå°±ä¼šæŠŠ funca ã€funcb å’Œ funcc å„è®¡æ•°ä¸€æ¬¡ï¼Œæ›´èƒ½ååº”å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<h2 id="æ¦‚å¿µ">
  æ¦‚å¿µ
  <a class="heading-link" href="#%e6%a6%82%e5%bf%b5">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>å‡½æ•°è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰å’Œç›¸åº”çš„æ ˆå¸§ï¼ˆStack Frameï¼‰æˆ‘ä»¬å…¶å®éƒ½ä¸é™Œç”Ÿï¼šåœ¨ä½¿ç”¨ gdb è°ƒè¯•ç¨‹åºçš„æ—¶å€™ï¼Œbtï¼ˆbacktraceï¼‰å‘½ä»¤æ‰“å°å‡ºæ¥çš„å°±æ˜¯å‡½æ•°è°ƒç”¨æ ˆï¼›è€Œå‡½æ•°è°ƒç”¨æ ˆåˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹åˆ™ä»£è¡¨ä¸€ä¸ªæ ˆå¸§ï¼Œæˆ‘ä»¬æ‰§è¡Œ frame å‘½ä»¤è·³è½¬åˆ°æŸä¸€ä¸ªæ ˆå¸§ï¼Œå…¶å®å°±æ˜¯ä¸€æ¬¡å›æº¯çš„è¿‡ç¨‹ã€‚</p>
<p>æƒ³è¦åœ¨å†…å­˜ä¸­è§£æå‡ºæˆ‘ä»¬æƒ³è¦çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„å°±æ˜¯ä¸€ä¸ªç¨‹åºçš„stack æ®µé‡Œé¢å„ä¸ªæ ˆå¸§æ˜¯å¦‚ä½•å¸ƒå±€çš„ï¼Œè¦ææ¸…æ¥šè¿™ä¸ªï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸ªæ¦‚å¿µå«ï¼š<a href="https://en.wikipedia.org/wiki/Calling_convention"  class="external-link" target="_blank" rel="noopener">è°ƒç”¨çº¦å®š</a>ï¼ˆCalling Conventionï¼‰ï¼Œè°ƒç”¨çº¦å®šä¸»è¦çº¦å®šäº†ï¼ˆå¥½ç»•ï¼‰ï¼š</p>
<ul>
<li>å‡½æ•°çš„å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Œæ˜¯å…¨éƒ½æ”¾åˆ°å¯„å­˜å™¨ï¼Œè¿˜æ˜¯å…¨éƒ½æ”¾åœ¨ stack æ®µï¼Œè¿˜æ˜¯æ··ç”¨ä¸¤è€…ï¼›</li>
<li>å‡½æ•°çš„å‚æ•°æ˜¯æŒ‰ä»€ä¹ˆé¡ºåºæ”¾ç½®åˆ°å†…å­˜ä¸­çš„ï¼›</li>
<li>å‡½æ•°ä¸­çš„æœ¬åœ°å˜é‡æ˜¯å¦‚ä½•åˆ†é…çš„ï¼›</li>
<li>å­å‡½æ•°è°ƒç”¨æ˜¯å¦‚ä½•è¿”å›çš„ï¼›</li>
<li>å­å‡½æ•°çš„æ ˆå¸§æ˜¯å¦‚ä½•æ¸…ç†çš„ï¼›</li>
<li>ç­‰ç­‰</li>
</ul>
<p>æ‰€ä»¥ï¼Œè°ƒç”¨çº¦å®šåŸºæœ¬ä¸Šå†³å®šäº†å‡½æ•°è°ƒç”¨ä¸­æ¯ä¸ªæ ˆå¸§çš„äº§ç”Ÿã€å‹æ ˆã€å‡ºæ ˆå¯¹å†…å­˜å¸ƒå±€çš„å½±å“ï¼Œè€Œè¿™ä¸ªçº¦å®šæ˜¯å› æ¶æ„å’Œå¹³å°è€Œå¼‚çš„ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨x86 å¹³å°ä¸‹çš„ <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#cdecl"  class="external-link" target="_blank" rel="noopener">cdecl</a> çº¦å®šã€‚</p>
<p>åœ¨è¿™ä¸ªçº¦å®šä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° <code>DrawSqure</code> è°ƒç”¨äº† <code>DrawLine</code> ï¼ˆä¾‹å­æ¥è‡ª<a href="https://en.wikipedia.org/wiki/Call_stack"  class="external-link" target="_blank" rel="noopener">Wikipedia</a>ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºå†…å­˜å¸ƒå±€ä¸­çš„ stack æ®µå°±åº”è¯¥æ˜¯ç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/img/2018/05/14/Call_stack_layout.svg" alt="call stack"></p>
<p>æ¯ä¸ªå‡½æ•°è°ƒç”¨å³åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ¯ä¸ªæ ˆå¸§ä¸€æ¬¡å‹å…¥ stack ä¸­ã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>Stack Pointer</code>(<code>esp</code>) æ°¸è¿œæŒ‡å‘æ ˆé¡¶ï¼Œ <code>Frame Pointer</code>(<code>ebp</code>) æŒ‡å‘å½“å‰æ ˆå¸§çš„ä¸­ä¸€ä¸ªå›ºå®šçš„åœ°æ–¹ï¼ˆåŸºåœ°å€ï¼‰ï¼›å‡½æ•°å‚æ•°ä»¥ä»å³å¾€å·¦çš„é¡ºåºä¾æ¬¡å‹æ ˆï¼Œç„¶åæ˜¯å‹å…¥<code>Return Address</code> ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°ï¼ˆæˆ–è€…æ ˆå¸§ï¼‰æ‰§è¡Œå®Œæˆåï¼Œç¨‹åºè¦ç»§ç»­æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œ åŒæ—¶å‹å…¥çˆ¶å‡½æ•°çš„æ ˆå¸§åŸºåœ°å€ï¼ˆ<code>Saved EBP</code>ï¼‰ï¼Œå®ƒæ˜¯å½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆä»¥åï¼Œ<code>Stack Pointer</code> å’Œ <code>Frame Pointer</code> å°†ä¼šæŒ‡å‘çš„åœ°æ–¹ï¼ŒåŸºäºè¿™ä¸ªåœ°å€ï¼Œç¨‹åºæŒ‡ä»¤å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å‡½æ•°æœ¬åœ°å˜é‡ï¼ˆ<code>ebp</code>è´Ÿå‘åç§»ï¼‰å’Œå‡½æ•°å‚æ•°ï¼ˆ<code>ebp</code>æ­£å‘åç§»ï¼‰ã€‚</p>
<p><img src="/img/2018/05/14/stackIntro.png" alt="stack info"></p>
<p>ç»“åˆä¸Šé¢ä¸¤å¼ å›¾ï¼Œå…¶å®å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªæ ˆå¸§å…¶å®éƒ½ä¿å­˜äº†ä¸Šä¸€ä¸ªæ ˆå¸§çš„åŸºåœ°å€ï¼Œå› æ­¤æ‰€æœ‰çš„æ ˆå¸§æœ€ç»ˆç»„æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬èƒ½æ‹¿åˆ°å‡½æ•°å †æ ˆçš„ç†è®ºåŸºç¡€äº†ã€‚</p>
<p>ï¼ˆæ³¨ï¼šä¸Šé¢åªæ˜¯ç²—ç•¥çš„è®²è§£ï¼Œå‚è€ƒé“¾æ¥ [1] éå¸¸è¯¦ç»†çš„æè¿°äº†å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ä¸­æ ˆå¸§ã€stack æ®µå’Œ<code>esp</code>ã€<code>ebp</code>å¯„å­˜å™¨çš„å˜åŒ–ï¼Œå¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è¯¦ç»†äº†è§£ä¸€ä¸‹ã€‚ï¼‰</p>
<h2 id="å‚è€ƒæ–¹æ¡ˆ">
  å‚è€ƒæ–¹æ¡ˆ
  <a class="heading-link" href="#%e5%8f%82%e8%80%83%e6%96%b9%e6%a1%88">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>çœ‹å®Œä¸Šé¢ä¸€å¤§ä¸²æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å‘ç°å¦‚æœæˆ‘ä»¬è¦æŒ‰ç…§å‡½æ•°çº¦å®šçš„æ–¹å¼å»è·å–å‡½æ•°è°ƒç”¨å †æ ˆï¼Œå¯ä»¥ï¼Œä½†æ˜¯å¤ªè¿‡è›‹ç–¼ï¼Œè€Œä¸”ä¸è·¨å¹³å°ï¼Œå¾ˆéš¾å—ã€‚ æ‰€ä»¥ç§‰æ‰¿ä¸è¦é‡å¤é€ è½®å­çš„ä¼˜è‰¯ä¼ ç»Ÿï¼Œæˆ‘ä»¬å‘ç°æœ‰å‡ ä¸ªæ–¹å¼å¯ä»¥ç®€å•åœ°è·å–åˆ°å‡½æ•°è°ƒç”¨æ ˆï¼š</p>
<ol>
<li>ç¥å¥‡çš„ <code>__builtin_return_address</code> å®ï¼›</li>
<li><code>glibc</code> çš„ <code>backtrace</code> å’Œ <code>backtrace_symbols</code>ï¼›</li>
<li><code>libunwind</code></li>
</ol>
<p>ç¬¬ä¸€ç§æ–¹æ¡ˆçœ‹èµ·æ¥å¾ˆç¥å¥‡ï¼Œä½ åœ¨ç¨‹åºä¸­å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡</p>
<pre tabindex="0"><code>printf(&#34;%p&#34;, __builtin_return_address(1))
</code></pre><p>æ‰“å°çˆ¶å‡½æ•°çš„åœ°å€ï¼Œå°† <code>1</code> æ¢æˆ <code>2</code>å°±å¯ä»¥æ‰“å°çˆ·çˆ·å‡½æ•°çš„åœ°å€ï¼Œä¾æ¬¡ç±»æ¨ã€‚ä½†æ˜¯å®ƒæœ‰ä¸¤ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¿™ä¸ªå®çš„å‚æ•°ä¸èƒ½ä½¿ç”¨å˜é‡ï¼›å¦å¤–ä¸€ä¸ªæ˜¯ä½ æ— æ³•çŸ¥é“è°ƒç”¨æ ˆå•¥æ—¶å€™åˆ°å¤´äº†ï¼Œå°±æ˜¯ä½ å¢åŠ å‚æ•°çš„å€¼ä¸¤æ¬¡ã€ä¸‰æ¬¡å‘ç°éƒ½èƒ½å¥½å¥½å·¥ä½œï¼Œç­‰åˆ°ä½ æŠŠå‚æ•°æ¢æˆå¯èƒ½<code>4</code>çš„æ—¶å€™ï¼Œä½ çš„ç¨‹åºâ€œå’”åš“â€å°±å´©æºƒäº†â€¦â€¦å¯èƒ½æ˜¯å› ä¸ºè®¿é—®åˆ°äº†æ ˆé¡¶ä»¥ä¸Šçš„å†…å­˜åœ°å€ï¼Ÿé¬¼çŸ¥é“â€¦â€¦</p>
<p>ç¬¬äºŒç§æ–¹å¼æœ‰ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre tabindex="0"><code>#include&lt;stdio.h&gt;
#include&lt;stdint.h&gt;
#include&lt;execinfo.h&gt;

#define SIZE 100

void print_backtrace()
{
	int size;
	void *buffer[SIZE];

	size = backtrace(buffer, SIZE);

	char** stack = backtrace_symbols(buffer, size);
	for (int i = 0; i &lt; size; i++) {
		printf(&#34;%s \n&#34;, stack[i]);
	}
}

int func_one(int a)
{
	print_backtrace();

	return a + 3;
}

int func_two(int a, int b)
{
	int c = func_one(a);

	return c + a;
}

int main(int argc, char** argv)
{
	func_two(1, 2);
	return 0;
}
</code></pre><p>éœ€è¦åœ¨ç»™  <code>gcc</code> æˆ–è€… <code>g++</code> ç¼–è¯‘çš„æ—¶å€™åŠ ä¸€ä¸ª <code>-rdynamic</code> çš„å‚æ•°[3]ï¼Œè¾“å‡ºç»“æœï¼š</p>
<pre tabindex="0"><code>./test-backtrace(print_backtrace+0x1f) [0x55d7f0ee9939] 
./test-backtrace(func_one+0x15) [0x55d7f0ee99ac] 
./test-backtrace(func_two+0x18) [0x55d7f0ee99cc] 
./test-backtrace(main+0x1e) [0x55d7f0ee99f7] 
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf1) [0x7f7c5aae22b1] 
./test-backtrace(_start+0x2a) [0x55d7f0ee983a] 
</code></pre><p>éƒ½ä¾èµ–ç¼–è¯‘åŠ å‚æ•°äº†ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é£æ ¼å˜›ï¼Œæ˜¾ç„¶ä¸èƒ½æ¥å—ã€‚</p>
<p>ç¬¬ä¸‰ç§æ–¹æ¡ˆ <code>libunwind</code> æ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„æ–¹æ¡ˆï¼Œè¿ <code>linux-perf</code> éƒ½åœ¨ç”¨å®ƒï¼Œé è°±åˆ°æˆ‘éƒ½æƒ³ç”¨ï¼</p>
<h2 id="ç¼–ç å®æˆ˜">
  ç¼–ç å®æˆ˜
  <a class="heading-link" href="#%e7%bc%96%e7%a0%81%e5%ae%9e%e6%88%98">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>åˆåˆ°äº†ç ä»£ç çš„æ—¶å€™äº†ï¼Œä¸è¿‡å› ä¸º <code>libunwind</code> ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªå‡½æ•°å³å¯ï¼š</p>
<pre tabindex="0"><code>void Backtrace()
{
    unw_cursor_t cursor;
    unw_context_t context;
    
    // context å°è£…äº†å½“å‰æœºå™¨çŠ¶æ€çš„å‚æ•°å€¼ï¼Œä¾‹å¦‚ä¸åŒå¯„å­˜å™¨çš„å€¼ç­‰
    // cursor ç›¸å½“äºæ˜¯æ ˆå¸§çš„è¿­ä»£å™¨
    unw_getcontext(&amp;context);
    unw_init_local(&amp;cursor, &amp;context);
    
    // ä¸€å¸§ä¸€å¸§åœ°å›æº¯ï¼Œç›´åˆ°æ²¡æœ‰å¯ç”¨çˆ¶æ ˆå¸§
    while (unw_step(&amp;cursor) &gt; 0) {
        unw_word_t offset, pc;
        // IP (instruction pointer) å°±æ˜¯ä¸Šé¢ä¸ªæˆ‘ä»¬æåˆ° Return address æ‰€æŒ‡å‘çš„åœ°å€
        unw_get_reg(&amp;cursor, UNW_REG_IP, &amp;pc); 
        if (pc == 0) {
            break;
        }
        printf(&#34;0x%lx \n&#34;, pc);
        
        // é€šè¿‡å‡½æ•°æŒ‡é’ˆï¼Œè·å–å‡½æ•°å¯¹åº”çš„åç§°
        char sym[256];
        if (unw_get_proc_name(&amp;cursor, sym, sizeof(sym), &amp;offset) == 0) {
            printf(&#34; (%s+0x%lx)\n&#34;, sym, offset); 
        } else {
            printf(&#34; -- error: unable to obtain symbol name for this frame\n&#34;);
        }
    }
}
</code></pre><p>é€è¿‡ä¸€ä¸ª <code>unw_cursor_t</code> æˆ‘ä»¬æ¯æ¬¡å›æº¯ä¸€å¸§ï¼Œç›´åˆ°æ²¡æœ‰å¯ç”¨çš„çˆ¶æ ˆå¸§ï¼Œåœ¨æ¯ä¸€ä¸ªæ ˆå¸§ä¸­ï¼Œè·å–åˆ°å½“å‰æ ˆå¸§çš„ <code>Return address</code> åŒºåŸŸæ‰€æŒ‡å‘çš„å‡½æ•°åœ°å€ï¼Œè¿™æ ·å°±æ„æˆäº†æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„å‡½æ•°æ ˆã€‚</p>
<p>è¿™ä¸ªæ—¶å€™åˆ«å¿˜äº†åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸ŠåŠ è½½ <code>libunwind</code>  è¿™ä¸ªåº“ï¼š</p>
<pre tabindex="0"><code>CONFIG += link_pkgconfig
PKGCONFIG += libunwind
</code></pre><p>ç„¶åï¼Œç”¨è¿™ä¸ªå‡½æ•°æ›¿æ¢æˆ‘ä»¬åŸæ¥çš„å ä½æ‰“å°ï¼š</p>
<pre tabindex="0"><code>void SigProfHandler(int, siginfo_t*, void*)
{
    _instace.disableProfile();

    // printf(&#34;Doing sampling here.&#34;);
    Backtrace();

    _instace.enableProfile();
}
</code></pre><p>å°±å¯ä»¥æ‰“å°å‡ºå‡½æ•°è°ƒç”¨æ ˆäº†ï¼š</p>
<pre tabindex="0"><code>0x7f773eb79011:  (_Z14SigProfHandleriP9siginfo_tPv+0x27)
0x7f773d66f0c0:  (__restore_rt+0x0)
0x557a9c3969e4:  (_ZN6Widget10consumeCPUEv+0x2e)
0x557a9c3970ec:  (_ZN9QtPrivate11FunctorCallINS_11IndexesListIJEEENS_4ListIJEEEvM6WidgetFvvEE4callES7_PS5_PPv+0x6b)
0x557a9c39707e:  (_ZN9QtPrivate15FunctionPointerIM6WidgetFvvEE4callINS_4ListIJEEEvEEvS3_PS1_PPv+0x42)
0x557a9c396fe8:  (_ZN9QtPrivate11QSlotObjectIM6WidgetFvvENS_4ListIJEEEvE4implEiPNS_15QSlotObjectBaseEP7QObjectPPvPb+0x75)
0x7f773dd8781c:  (_ZN11QMetaObject8activateEP7QObjectiiPPv+0x99c)
0x7f773dd93dd8:  (_ZN6QTimer10timerEventEP11QTimerEvent+0x28)
0x7f773dd8826b:  (_ZN7QObject5eventEP6QEvent+0x7b)
0x7f773e67728c:  (_ZN19QApplicationPrivate13notify_helperEP7QObjectP6QEvent+0x9c)
0x7f773e67c37f:  (_ZN12QApplication6notifyEP7QObjectP6QEvent+0x23f)
0x7f773dd5c268:  (_ZN16QCoreApplication15notifyInternal2EP7QObjectP6QEvent+0x108)
0x7f773ddadbde:  (_ZN14QTimerInfoList14activateTimersEv+0x4de)
0x7f773ddae101:  (_ZN14QTimerInfoList14activateTimersEv+0xa01)
0x7f773c2ef887:  (g_main_context_dispatch+0x287)
0x7f773c2efab8:  (g_main_context_dispatch+0x4b8)
0x7f773c2efb5c:  (g_main_context_iteration+0x2c)
0x7f773ddaec3f:  (_ZN20QEventDispatcherGlib13processEventsE6QFlagsIN10QEventLoop17ProcessEventsFlagEE+0x5f)
0x7f773dd5a53a:  (_ZN10QEventLoop4execE6QFlagsINS_17ProcessEventsFlagEE+0xea)
0x7f773dd625ed:  (_ZN16QCoreApplication4execEv+0x8d)
0x557a9c3967a5:  (main+0x4b)
0x7f773ca452b1:  (__libc_start_main+0xf1)
0x557a9c39667a:  (_start+0x2a)
</code></pre><p>ä¸è¿‡é‚£äº›å‡½æ•°åç§°æ˜¯æ€ä¹ˆæå¾—ï¼Ÿå½“ç„¶æ˜¯è‘—åçš„ <a href="https://en.wikipedia.org/wiki/Name_mangling"  class="external-link" target="_blank" rel="noopener">C++ mangling</a> äº†ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· <code>c++filt</code> å¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œâ€œè§£å¯†â€å·¥ä½œï¼š</p>
<pre tabindex="0"><code>$&gt; c++filt _ZN10QEventLoop4execE6QFlagsINS_17ProcessEventsFlagEE
$&gt; QEventLoop::exec(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;)
</code></pre><p>åœ¨ä»£ç é‡Œé¢æˆ‘ä»¬å¯ä»¥å€ŸåŠ©äº  <code>libstdc++</code> æä¾›çš„ <code>cxxabi.h</code> çš„ <code>API</code>  æ¥å®ç° demanglingï¼š</p>
<pre tabindex="0"><code>char sym[256];
if (unw_get_proc_name(&amp;cursor, sym, sizeof(sym), &amp;offset) == 0) {
    char* nameptr = sym;
    int status;
    char* demangled = abi::__cxa_demangle(sym, nullptr, nullptr, &amp;status);
    if (status == 0) {
        nameptr = demangled;
    }
    printf(&#34; (%s+0x%lx)\n&#34;, nameptr, offset);
    free(demangled);
} else {
    printf(&#34; -- error: unable to obtain symbol name for this frame\n&#34;);
}
</code></pre><p>è¿™æ—¶å€™å†çœ‹å‡½æ•°è°ƒç”¨æ ˆæ‰“å°å°±æ¯”è¾ƒå®Œç¾äº†ã€‚</p>
<pre tabindex="0"><code>0x7fc6ef4350fe:  (SigProfHandler(int, siginfo_t*, void*)+0x27)
0x7fc6edf2b0c0:  (__restore_rt+0x0)
0x5581be96575b:  (Widget::consumeCPU()+0x25)
0x5581be965b16:  (QtPrivate::FunctorCall&lt;QtPrivate::IndexesList&lt;&gt;, QtPrivate::List&lt;&gt;, void, void (Widget::*)()&gt;::call(void (Widget::*)(), Widget*, void**)+0x6b)
0x5581be965aa8:  (void QtPrivate::FunctionPointer&lt;void (Widget::*)()&gt;::call&lt;QtPrivate::List&lt;&gt;, void&gt;(void (Widget::*)(), Widget*, void**)+0x42)
0x5581be965a12:  (QtPrivate::QSlotObject&lt;void (Widget::*)(), QtPrivate::List&lt;&gt;, void&gt;::impl(int, QtPrivate::QSlotObjectBase*, QObject*, void**, bool*)+0x75)
0x7fc6ee64381c:  (QMetaObject::activate(QObject*, int, int, void**)+0x99c)
0x7fc6ee64fdd8:  (QTimer::timerEvent(QTimerEvent*)+0x28)
0x7fc6ee64426b:  (QObject::event(QEvent*)+0x7b)
0x7fc6eef3328c:  (QApplicationPrivate::notify_helper(QObject*, QEvent*)+0x9c)
0x7fc6eef3837f:  (QApplication::notify(QObject*, QEvent*)+0x23f)
0x7fc6ee618268:  (QCoreApplication::notifyInternal2(QObject*, QEvent*)+0x108)
0x7fc6ee669bde:  (QTimerInfoList::activateTimers()+0x4de)
0x7fc6ee66a139:  (QTimerInfoList::activateTimers()+0xa39)
0x7fc6ecbab887:  (g_main_context_dispatch+0x287)
0x7fc6ecbabab8:  (g_main_context_dispatch+0x4b8)
0x7fc6ecbabb5c:  (g_main_context_iteration+0x2c)
0x7fc6ee66ac3f:  (QEventDispatcherGlib::processEvents(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;)+0x5f)
0x7fc6ee61653a:  (QEventLoop::exec(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;)+0xea)
0x7fc6ee61e5ed:  (QCoreApplication::exec()+0x8d)
0x5581be965525:  (main+0x4b)
0x7fc6ed3012b1:  (__libc_start_main+0xf1)
0x5581be9653fa:  (_start+0x2a)
</code></pre><p>å†ä»”ç»†çœ‹ä¸€çœ¼ï¼Œè¾“å‡ºçš„ä¸€ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªä¸å¥‡æ€ªï¼Œä½†æ˜¯ç¬¬äºŒä¸ª <code>__restore_rt</code>  æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</p>
<p>å¦å¤–ï¼Œå…¶å®ä¸Šé¢ä»£ç ä¸­é€šè¿‡å‡½æ•°åœ°å€è·å–å‡½æ•°åç§°çš„åœ°æ–¹æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æ¯æ¬¡é‡‡æ ·éƒ½åšè¿™ä¸ªæ“ä½œæ˜¯æ¯”è¾ƒå‘çš„ï¼Œä¼šä¸¥é‡å½±å“ tracee ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œæˆ‘ä»¬åªèƒ½åœ¨é‡‡æ ·çš„æ—¶å€™å…ˆè®°å½•è¿™äº›å‡½æ•°åœ°å€ï¼Œäº‹åè¿›è¡Œç»Ÿè®¡æ“ä½œçš„æ—¶å€™å†è§£æåˆ°å‡½æ•°çš„åç§°ã€‚ä¸ºä»€ä¹ˆé€šè¿‡å‡½æ•°åœ°å€è·å–å‡½æ•°åç§°è¿™ä¹ˆè€—æ—¶å‘¢ï¼Ÿ</p>
<p>è¿åŒä¸Šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­çš„ä¸¤ç¯‡ä¸­ç»™å‡ºç­”æ¡ˆã€‚</p>
<p>æœ¬ç¯‡ä»£ç åœ°å€ï¼š <a href="https://github.com/hualet/simple-profiler/tree/part2"  class="external-link" target="_blank" rel="noopener">https://github.com/hualet/simple-profiler/tree/part2</a></p>
<h2 id="å‚è€ƒé“¾æ¥">
  å‚è€ƒé“¾æ¥
  <a class="heading-link" href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>[1] <a href="https://manybutfinite.com/post/journey-to-the-stack/"  class="external-link" target="_blank" rel="noopener">Journey to the stack, Part I</a></p>
<p>[2] <a href="https://eli.thegreenplace.net/2015/programmatic-access-to-the-call-stack-in-c/"  class="external-link" target="_blank" rel="noopener">Programmatic access to the call stack in C++</a></p>
<p>[3] <a href="https://stackoverflow.com/questions/6934659/how-to-make-backtrace-backtrace-symbols-print-the-function-names"  class="external-link" target="_blank" rel="noopener">How to make backtrace()/backtrace_symbols() print the function names?</a></p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hualetblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
      2019 -
    
    2025
     Hualet Wang 
    Â·
    
     <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6FNRR2W3Z7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6FNRR2W3Z7');
</script>


  

  

  

  

  

  

  

  
</body>
</html>
