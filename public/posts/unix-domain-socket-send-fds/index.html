<!DOCTYPE html>
<html lang="zh">

<head>
  <title>
  é€šè¿‡ Unix Domain Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ Â· Think in Hualet
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Hualet Wang">
<meta name="description" content="Unix Domain Socket æ˜¯ Unix ç³»ç»Ÿä¸‹é‡è¦çš„æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ä¹‹ä¸€ï¼Œåœ¨ DDEã€GNOMEã€KDE ç­‰ Linux æ¡Œé¢ç¯å¢ƒä¸­å¸¸è§çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ DBus æœ‰ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäº Unix Domain Socket åšçš„ã€‚è™½ç„¶ä¸€ç›´çŸ¥é“å®ƒçš„å¤§åï¼Œä¹Ÿä¸€ç›´çŸ¥é“ Unix Domain Socket å¯ä»¥ç”¨æ¥ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ç¢äºä»¥å‰ç»éªŒå’Œçœ¼ç•Œä¸è¶³ï¼ŒåŠ ä¸Šæ²¡æœ‰æ·±å…¥å»äº†è§£ï¼Œå®Œå…¨ä¸çŸ¥é“èƒ½ä¼ é€’æ–‡ä»¶æè¿°ç¬¦æ˜¯å¤šä¹ˆå¼ºå¤§çš„èƒ½åŠ›å’Œå¿…è¦æ€§ã€‚
é¦–å…ˆï¼Œæˆ‘æƒ³ç€æ–‡ä»¶æè¿°ç¬¦ä¸å°±æ˜¯ä¸€ä¸ªæ•°å­—ä¹ˆï¼Œå“ªä¸ª IPC ä¸èƒ½ä¼ é€’æ•°å­—å‘¢ï¼Ÿå®Œå…¨æ²¡æœ‰æ€è€ƒåˆ°æ–‡ä»¶æè¿°ç¬¦æ˜¯åªåœ¨è¿›ç¨‹èŒƒå›´å†…æœ‰æ•ˆï¼ŒåŒæ ·ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹å®Œå…¨å°±ä¸æ˜¯ä¸€å›äº‹å„¿ã€‚è¿™æ—¶å€™ä½ è‚¯å®šæƒ³ï¼Œæ—¢ç„¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿™ä¹ˆéº»çƒ¦ï¼Œä¸ºå•¥éè¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Œä½¿ç”¨æ–‡ä»¶åä¸ä¹Ÿæ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿé‚£ä¹ˆæ­å–œä½ ï¼Œä½ ä¹Ÿæœ‰æ›´æˆ‘ä¸€æ ·åœ¨è·µè¡Œé™¶æ¸Šæ˜è€å‰è¾ˆçœ‹äº‹ç‰©â€œä¸æ±‚ç”šè§£â€çš„ä½œé£ã€‚ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿˜æ˜¯æœ‰å®ƒçš„å¿…è¦æ€§çš„ï¼Œä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨çš„ä¸åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒè¿˜åŒ…å«äº†æ–‡ä»¶æ‰“å¼€çš„çŠ¶æ€ï¼Œæ¯”å¦‚ seek çš„ä½ç½®ç­‰ï¼Œæœ‰ç‚¹è¿›ç¨‹ä¹‹äºå¯æ‰§è¡Œç¨‹åºçš„æ„æ€ï¼Œæ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°±æ‹¿åˆ°äº†è¿™äº›åŠ¨æ€çš„ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸åªå¯¹åº”äºæœ¬åœ°æ–‡ä»¶ï¼Œå®ƒä¸ºäº†ä¸€ä¼—å¯è¯»å†™å¯¹è±¡æä¾›äº†ç»Ÿä¸€çš„è¯»å†™æ¥å£ï¼ŒåŒ…å«ä»€ä¹ˆå‘¢ï¼Ÿæœ¬åœ°æ–‡ä»¶ã€ï¼ˆåŒ¿åï¼‰ç®¡é“ã€æ ‡å‡†è¾“å…¥è¾“å‡ºã€ç”šè‡³äº Socket æœ¬èº«ç­‰â€¦â€¦å¯ä»¥è®©ä½ å®Œå…¨ä¸å…³å¿ƒæ–‡ä»¶æè¿°ç¬¦èƒŒåçš„å®ç°æ˜¯ä»€ä¹ˆè€Œæ–¹ä¾¿å®ç°è‡ªå·±çš„é€»è¾‘ä»£ç ã€‚
æƒ³é€šäº†ä»¥ä¸Šé“ç†ï¼Œåˆæœ‰äº†ä»¥å‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿæ…¨â€œå¤äººè¯šä¸æ¬ºæˆ‘â€â€”â€”å‰äººç•™ä¸‹çš„ä¸œè¥¿ï¼Œå¿…ç„¶æœ‰ä¸€å®šçš„åˆç†æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æ¯”è¾ƒæ’æ–¥çœ‹è§ä¸€ä¸ªè½¯ä»¶ä¸æ»¡æ„å°±ç«‹å³é‡æ–°é€ ï¼Œå°¤å…¶æ˜¯èƒ½æµä¼ å¾ˆå¹¿æˆ–è€…æµç¨‹æ—¶é—´å¾ˆé•¿çš„è½¯ä»¶ï¼Œé‡Œé¢å¾ˆå¤šçœ‹èµ·æ¥ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œå¯èƒ½æœ‰å…¶å­˜åœ¨çš„åˆç†æ€§ï¼Œæœ€å¥½çš„åšæ³•æ˜¯å°è¯•å»æ”¹è¿›ï¼Œæ”¹è¿›çš„è¿‡ç¨‹äº†è§£å…¶å†å²ã€å­¦ä¹ å…¶ç²¾é«“ï¼Œç­‰è‡ªå·±èƒ¸æœ‰æˆç«¹çš„æ—¶å€™å†ä¸‹æ‰‹é‡é€ ä¸è¿Ÿã€‚é¢ï¼Œè·‘é¢˜äº†â€¦â€¦
å›åˆ°æ­£é¢˜ï¼Œä¹‹æ‰€ä»¥å‰æ®µæ—¶é—´çªç„¶ç ”ç©¶äº†ä¸€ä¸‹ Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„ä¸œè¥¿ï¼Œæ˜¯é‡åˆ°è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šä¸€ä¸ªè¿›ç¨‹å°†è‡ªå·±çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹ç›¸åº”çš„ä½ç½®ã€‚å¸¦ç€å¯¹ Unix Domain Socket çš„æœ¦èƒ§è®¤è¯†ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„å®ç°åŸå‹ï¼š
// outlet.c #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #define SOCKET_NAME &#34;/tmp/connection-uds-fd&#34; int make_connection() { int fd; int connection_fd; int result; struct sockaddr_un sun; fd = socket(PF_UNIX, SOCK_STREAM, 0); sun.sun_family = AF_UNIX; strncpy(sun.">
<meta name="keywords" content="blog,developer,personal">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="é€šè¿‡ Unix Domain Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦">
  <meta name="twitter:description" content="Unix Domain Socket æ˜¯ Unix ç³»ç»Ÿä¸‹é‡è¦çš„æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ä¹‹ä¸€ï¼Œåœ¨ DDEã€GNOMEã€KDE ç­‰ Linux æ¡Œé¢ç¯å¢ƒä¸­å¸¸è§çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ DBus æœ‰ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäº Unix Domain Socket åšçš„ã€‚è™½ç„¶ä¸€ç›´çŸ¥é“å®ƒçš„å¤§åï¼Œä¹Ÿä¸€ç›´çŸ¥é“ Unix Domain Socket å¯ä»¥ç”¨æ¥ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ç¢äºä»¥å‰ç»éªŒå’Œçœ¼ç•Œä¸è¶³ï¼ŒåŠ ä¸Šæ²¡æœ‰æ·±å…¥å»äº†è§£ï¼Œå®Œå…¨ä¸çŸ¥é“èƒ½ä¼ é€’æ–‡ä»¶æè¿°ç¬¦æ˜¯å¤šä¹ˆå¼ºå¤§çš„èƒ½åŠ›å’Œå¿…è¦æ€§ã€‚
é¦–å…ˆï¼Œæˆ‘æƒ³ç€æ–‡ä»¶æè¿°ç¬¦ä¸å°±æ˜¯ä¸€ä¸ªæ•°å­—ä¹ˆï¼Œå“ªä¸ª IPC ä¸èƒ½ä¼ é€’æ•°å­—å‘¢ï¼Ÿå®Œå…¨æ²¡æœ‰æ€è€ƒåˆ°æ–‡ä»¶æè¿°ç¬¦æ˜¯åªåœ¨è¿›ç¨‹èŒƒå›´å†…æœ‰æ•ˆï¼ŒåŒæ ·ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹å®Œå…¨å°±ä¸æ˜¯ä¸€å›äº‹å„¿ã€‚è¿™æ—¶å€™ä½ è‚¯å®šæƒ³ï¼Œæ—¢ç„¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿™ä¹ˆéº»çƒ¦ï¼Œä¸ºå•¥éè¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Œä½¿ç”¨æ–‡ä»¶åä¸ä¹Ÿæ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿé‚£ä¹ˆæ­å–œä½ ï¼Œä½ ä¹Ÿæœ‰æ›´æˆ‘ä¸€æ ·åœ¨è·µè¡Œé™¶æ¸Šæ˜è€å‰è¾ˆçœ‹äº‹ç‰©â€œä¸æ±‚ç”šè§£â€çš„ä½œé£ã€‚ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿˜æ˜¯æœ‰å®ƒçš„å¿…è¦æ€§çš„ï¼Œä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨çš„ä¸åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒè¿˜åŒ…å«äº†æ–‡ä»¶æ‰“å¼€çš„çŠ¶æ€ï¼Œæ¯”å¦‚ seek çš„ä½ç½®ç­‰ï¼Œæœ‰ç‚¹è¿›ç¨‹ä¹‹äºå¯æ‰§è¡Œç¨‹åºçš„æ„æ€ï¼Œæ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°±æ‹¿åˆ°äº†è¿™äº›åŠ¨æ€çš„ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸åªå¯¹åº”äºæœ¬åœ°æ–‡ä»¶ï¼Œå®ƒä¸ºäº†ä¸€ä¼—å¯è¯»å†™å¯¹è±¡æä¾›äº†ç»Ÿä¸€çš„è¯»å†™æ¥å£ï¼ŒåŒ…å«ä»€ä¹ˆå‘¢ï¼Ÿæœ¬åœ°æ–‡ä»¶ã€ï¼ˆåŒ¿åï¼‰ç®¡é“ã€æ ‡å‡†è¾“å…¥è¾“å‡ºã€ç”šè‡³äº Socket æœ¬èº«ç­‰â€¦â€¦å¯ä»¥è®©ä½ å®Œå…¨ä¸å…³å¿ƒæ–‡ä»¶æè¿°ç¬¦èƒŒåçš„å®ç°æ˜¯ä»€ä¹ˆè€Œæ–¹ä¾¿å®ç°è‡ªå·±çš„é€»è¾‘ä»£ç ã€‚
æƒ³é€šäº†ä»¥ä¸Šé“ç†ï¼Œåˆæœ‰äº†ä»¥å‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿæ…¨â€œå¤äººè¯šä¸æ¬ºæˆ‘â€â€”â€”å‰äººç•™ä¸‹çš„ä¸œè¥¿ï¼Œå¿…ç„¶æœ‰ä¸€å®šçš„åˆç†æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æ¯”è¾ƒæ’æ–¥çœ‹è§ä¸€ä¸ªè½¯ä»¶ä¸æ»¡æ„å°±ç«‹å³é‡æ–°é€ ï¼Œå°¤å…¶æ˜¯èƒ½æµä¼ å¾ˆå¹¿æˆ–è€…æµç¨‹æ—¶é—´å¾ˆé•¿çš„è½¯ä»¶ï¼Œé‡Œé¢å¾ˆå¤šçœ‹èµ·æ¥ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œå¯èƒ½æœ‰å…¶å­˜åœ¨çš„åˆç†æ€§ï¼Œæœ€å¥½çš„åšæ³•æ˜¯å°è¯•å»æ”¹è¿›ï¼Œæ”¹è¿›çš„è¿‡ç¨‹äº†è§£å…¶å†å²ã€å­¦ä¹ å…¶ç²¾é«“ï¼Œç­‰è‡ªå·±èƒ¸æœ‰æˆç«¹çš„æ—¶å€™å†ä¸‹æ‰‹é‡é€ ä¸è¿Ÿã€‚é¢ï¼Œè·‘é¢˜äº†â€¦â€¦
å›åˆ°æ­£é¢˜ï¼Œä¹‹æ‰€ä»¥å‰æ®µæ—¶é—´çªç„¶ç ”ç©¶äº†ä¸€ä¸‹ Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„ä¸œè¥¿ï¼Œæ˜¯é‡åˆ°è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šä¸€ä¸ªè¿›ç¨‹å°†è‡ªå·±çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹ç›¸åº”çš„ä½ç½®ã€‚å¸¦ç€å¯¹ Unix Domain Socket çš„æœ¦èƒ§è®¤è¯†ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„å®ç°åŸå‹ï¼š
// outlet.c #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #define SOCKET_NAME &#34;/tmp/connection-uds-fd&#34; int make_connection() { int fd; int connection_fd; int result; struct sockaddr_un sun; fd = socket(PF_UNIX, SOCK_STREAM, 0); sun.sun_family = AF_UNIX; strncpy(sun.">

<meta property="og:url" content="https://www.hualet.org/posts/unix-domain-socket-send-fds/">
  <meta property="og:site_name" content="Think in Hualet">
  <meta property="og:title" content="é€šè¿‡ Unix Domain Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦">
  <meta property="og:description" content="Unix Domain Socket æ˜¯ Unix ç³»ç»Ÿä¸‹é‡è¦çš„æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ä¹‹ä¸€ï¼Œåœ¨ DDEã€GNOMEã€KDE ç­‰ Linux æ¡Œé¢ç¯å¢ƒä¸­å¸¸è§çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ DBus æœ‰ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäº Unix Domain Socket åšçš„ã€‚è™½ç„¶ä¸€ç›´çŸ¥é“å®ƒçš„å¤§åï¼Œä¹Ÿä¸€ç›´çŸ¥é“ Unix Domain Socket å¯ä»¥ç”¨æ¥ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ç¢äºä»¥å‰ç»éªŒå’Œçœ¼ç•Œä¸è¶³ï¼ŒåŠ ä¸Šæ²¡æœ‰æ·±å…¥å»äº†è§£ï¼Œå®Œå…¨ä¸çŸ¥é“èƒ½ä¼ é€’æ–‡ä»¶æè¿°ç¬¦æ˜¯å¤šä¹ˆå¼ºå¤§çš„èƒ½åŠ›å’Œå¿…è¦æ€§ã€‚
é¦–å…ˆï¼Œæˆ‘æƒ³ç€æ–‡ä»¶æè¿°ç¬¦ä¸å°±æ˜¯ä¸€ä¸ªæ•°å­—ä¹ˆï¼Œå“ªä¸ª IPC ä¸èƒ½ä¼ é€’æ•°å­—å‘¢ï¼Ÿå®Œå…¨æ²¡æœ‰æ€è€ƒåˆ°æ–‡ä»¶æè¿°ç¬¦æ˜¯åªåœ¨è¿›ç¨‹èŒƒå›´å†…æœ‰æ•ˆï¼ŒåŒæ ·ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹å®Œå…¨å°±ä¸æ˜¯ä¸€å›äº‹å„¿ã€‚è¿™æ—¶å€™ä½ è‚¯å®šæƒ³ï¼Œæ—¢ç„¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿™ä¹ˆéº»çƒ¦ï¼Œä¸ºå•¥éè¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Œä½¿ç”¨æ–‡ä»¶åä¸ä¹Ÿæ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿé‚£ä¹ˆæ­å–œä½ ï¼Œä½ ä¹Ÿæœ‰æ›´æˆ‘ä¸€æ ·åœ¨è·µè¡Œé™¶æ¸Šæ˜è€å‰è¾ˆçœ‹äº‹ç‰©â€œä¸æ±‚ç”šè§£â€çš„ä½œé£ã€‚ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿˜æ˜¯æœ‰å®ƒçš„å¿…è¦æ€§çš„ï¼Œä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨çš„ä¸åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒè¿˜åŒ…å«äº†æ–‡ä»¶æ‰“å¼€çš„çŠ¶æ€ï¼Œæ¯”å¦‚ seek çš„ä½ç½®ç­‰ï¼Œæœ‰ç‚¹è¿›ç¨‹ä¹‹äºå¯æ‰§è¡Œç¨‹åºçš„æ„æ€ï¼Œæ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°±æ‹¿åˆ°äº†è¿™äº›åŠ¨æ€çš„ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸åªå¯¹åº”äºæœ¬åœ°æ–‡ä»¶ï¼Œå®ƒä¸ºäº†ä¸€ä¼—å¯è¯»å†™å¯¹è±¡æä¾›äº†ç»Ÿä¸€çš„è¯»å†™æ¥å£ï¼ŒåŒ…å«ä»€ä¹ˆå‘¢ï¼Ÿæœ¬åœ°æ–‡ä»¶ã€ï¼ˆåŒ¿åï¼‰ç®¡é“ã€æ ‡å‡†è¾“å…¥è¾“å‡ºã€ç”šè‡³äº Socket æœ¬èº«ç­‰â€¦â€¦å¯ä»¥è®©ä½ å®Œå…¨ä¸å…³å¿ƒæ–‡ä»¶æè¿°ç¬¦èƒŒåçš„å®ç°æ˜¯ä»€ä¹ˆè€Œæ–¹ä¾¿å®ç°è‡ªå·±çš„é€»è¾‘ä»£ç ã€‚
æƒ³é€šäº†ä»¥ä¸Šé“ç†ï¼Œåˆæœ‰äº†ä»¥å‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿæ…¨â€œå¤äººè¯šä¸æ¬ºæˆ‘â€â€”â€”å‰äººç•™ä¸‹çš„ä¸œè¥¿ï¼Œå¿…ç„¶æœ‰ä¸€å®šçš„åˆç†æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æ¯”è¾ƒæ’æ–¥çœ‹è§ä¸€ä¸ªè½¯ä»¶ä¸æ»¡æ„å°±ç«‹å³é‡æ–°é€ ï¼Œå°¤å…¶æ˜¯èƒ½æµä¼ å¾ˆå¹¿æˆ–è€…æµç¨‹æ—¶é—´å¾ˆé•¿çš„è½¯ä»¶ï¼Œé‡Œé¢å¾ˆå¤šçœ‹èµ·æ¥ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œå¯èƒ½æœ‰å…¶å­˜åœ¨çš„åˆç†æ€§ï¼Œæœ€å¥½çš„åšæ³•æ˜¯å°è¯•å»æ”¹è¿›ï¼Œæ”¹è¿›çš„è¿‡ç¨‹äº†è§£å…¶å†å²ã€å­¦ä¹ å…¶ç²¾é«“ï¼Œç­‰è‡ªå·±èƒ¸æœ‰æˆç«¹çš„æ—¶å€™å†ä¸‹æ‰‹é‡é€ ä¸è¿Ÿã€‚é¢ï¼Œè·‘é¢˜äº†â€¦â€¦
å›åˆ°æ­£é¢˜ï¼Œä¹‹æ‰€ä»¥å‰æ®µæ—¶é—´çªç„¶ç ”ç©¶äº†ä¸€ä¸‹ Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„ä¸œè¥¿ï¼Œæ˜¯é‡åˆ°è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šä¸€ä¸ªè¿›ç¨‹å°†è‡ªå·±çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹ç›¸åº”çš„ä½ç½®ã€‚å¸¦ç€å¯¹ Unix Domain Socket çš„æœ¦èƒ§è®¤è¯†ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„å®ç°åŸå‹ï¼š
// outlet.c #include &lt;sys/socket.h&gt; #include &lt;sys/un.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;unistd.h&gt; #define SOCKET_NAME &#34;/tmp/connection-uds-fd&#34; int make_connection() { int fd; int connection_fd; int result; struct sockaddr_un sun; fd = socket(PF_UNIX, SOCK_STREAM, 0); sun.sun_family = AF_UNIX; strncpy(sun.">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-10-28T21:08:45+08:00">
    <meta property="article:modified_time" content="2018-10-28T21:08:45+08:00">




<link rel="canonical" href="https://www.hualet.org/posts/unix-domain-socket-send-fds/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://www.hualet.org/">
      Think in Hualet
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">åšå®¢</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/blogroll/">å‹é“¾</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">å…³äº</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/en/">ğŸ‡¬ğŸ‡§</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://www.hualet.org/posts/unix-domain-socket-send-fds/">
              é€šè¿‡ Unix Domain Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2018-10-28T21:08:45&#43;08:00">
                åæœˆ 28, 2018
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>Unix Domain Socket æ˜¯ Unix ç³»ç»Ÿä¸‹é‡è¦çš„æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ä¹‹ä¸€ï¼Œåœ¨ DDEã€GNOMEã€KDE ç­‰ Linux æ¡Œé¢ç¯å¢ƒä¸­å¸¸è§çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ DBus æœ‰ä¸€ç§å®ç°æ–¹å¼å°±æ˜¯åŸºäº Unix Domain Socket åšçš„ã€‚è™½ç„¶ä¸€ç›´çŸ¥é“å®ƒçš„å¤§åï¼Œä¹Ÿä¸€ç›´çŸ¥é“ Unix Domain Socket å¯ä»¥ç”¨æ¥ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ç¢äºä»¥å‰ç»éªŒå’Œçœ¼ç•Œä¸è¶³ï¼ŒåŠ ä¸Šæ²¡æœ‰æ·±å…¥å»äº†è§£ï¼Œå®Œå…¨ä¸çŸ¥é“èƒ½ä¼ é€’æ–‡ä»¶æè¿°ç¬¦æ˜¯å¤šä¹ˆå¼ºå¤§çš„èƒ½åŠ›å’Œå¿…è¦æ€§ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘æƒ³ç€æ–‡ä»¶æè¿°ç¬¦ä¸å°±æ˜¯ä¸€ä¸ªæ•°å­—ä¹ˆï¼Œå“ªä¸ª IPC ä¸èƒ½ä¼ é€’æ•°å­—å‘¢ï¼Ÿå®Œå…¨æ²¡æœ‰æ€è€ƒåˆ°æ–‡ä»¶æè¿°ç¬¦æ˜¯åªåœ¨è¿›ç¨‹èŒƒå›´å†…æœ‰æ•ˆï¼ŒåŒæ ·ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹å®Œå…¨å°±ä¸æ˜¯ä¸€å›äº‹å„¿ã€‚è¿™æ—¶å€™ä½ è‚¯å®šæƒ³ï¼Œæ—¢ç„¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿™ä¹ˆéº»çƒ¦ï¼Œä¸ºå•¥éè¦ä¼ é€’æ–‡ä»¶æè¿°ç¬¦å‘¢ï¼Œä½¿ç”¨æ–‡ä»¶åä¸ä¹Ÿæ˜¯ä¸€æ ·çš„ä¹ˆï¼Ÿé‚£ä¹ˆæ­å–œä½ ï¼Œä½ ä¹Ÿæœ‰æ›´æˆ‘ä¸€æ ·åœ¨è·µè¡Œé™¶æ¸Šæ˜è€å‰è¾ˆçœ‹äº‹ç‰©â€œä¸æ±‚ç”šè§£â€çš„ä½œé£ã€‚ä¼ é€’æ–‡ä»¶æè¿°ç¬¦è¿˜æ˜¯æœ‰å®ƒçš„å¿…è¦æ€§çš„ï¼Œä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä»£è¡¨çš„ä¸åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒè¿˜åŒ…å«äº†æ–‡ä»¶æ‰“å¼€çš„çŠ¶æ€ï¼Œæ¯”å¦‚ seek çš„ä½ç½®ç­‰ï¼Œæœ‰ç‚¹è¿›ç¨‹ä¹‹äºå¯æ‰§è¡Œç¨‹åºçš„æ„æ€ï¼Œæ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°±æ‹¿åˆ°äº†è¿™äº›åŠ¨æ€çš„ä¿¡æ¯ï¼›å¦ä¸€æ–¹é¢ï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸åªå¯¹åº”äºæœ¬åœ°æ–‡ä»¶ï¼Œå®ƒä¸ºäº†ä¸€ä¼—å¯è¯»å†™å¯¹è±¡æä¾›äº†ç»Ÿä¸€çš„è¯»å†™æ¥å£ï¼ŒåŒ…å«ä»€ä¹ˆå‘¢ï¼Ÿæœ¬åœ°æ–‡ä»¶ã€ï¼ˆåŒ¿åï¼‰ç®¡é“ã€æ ‡å‡†è¾“å…¥è¾“å‡ºã€ç”šè‡³äº Socket æœ¬èº«ç­‰â€¦â€¦å¯ä»¥è®©ä½ å®Œå…¨ä¸å…³å¿ƒæ–‡ä»¶æè¿°ç¬¦èƒŒåçš„å®ç°æ˜¯ä»€ä¹ˆè€Œæ–¹ä¾¿å®ç°è‡ªå·±çš„é€»è¾‘ä»£ç ã€‚</p>
<p>æƒ³é€šäº†ä»¥ä¸Šé“ç†ï¼Œåˆæœ‰äº†ä»¥å‰ä¼¼æ›¾ç›¸è¯†çš„æ„Ÿæ…¨â€œå¤äººè¯šä¸æ¬ºæˆ‘â€â€”â€”å‰äººç•™ä¸‹çš„ä¸œè¥¿ï¼Œå¿…ç„¶æœ‰ä¸€å®šçš„åˆç†æ€§ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘æ¯”è¾ƒæ’æ–¥çœ‹è§ä¸€ä¸ªè½¯ä»¶ä¸æ»¡æ„å°±ç«‹å³é‡æ–°é€ ï¼Œå°¤å…¶æ˜¯èƒ½æµä¼ å¾ˆå¹¿æˆ–è€…æµç¨‹æ—¶é—´å¾ˆé•¿çš„è½¯ä»¶ï¼Œé‡Œé¢å¾ˆå¤šçœ‹èµ·æ¥ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œå¯èƒ½æœ‰å…¶å­˜åœ¨çš„åˆç†æ€§ï¼Œæœ€å¥½çš„åšæ³•æ˜¯å°è¯•å»æ”¹è¿›ï¼Œæ”¹è¿›çš„è¿‡ç¨‹äº†è§£å…¶å†å²ã€å­¦ä¹ å…¶ç²¾é«“ï¼Œç­‰è‡ªå·±èƒ¸æœ‰æˆç«¹çš„æ—¶å€™å†ä¸‹æ‰‹é‡é€ ä¸è¿Ÿã€‚é¢ï¼Œè·‘é¢˜äº†â€¦â€¦</p>
<p>å›åˆ°æ­£é¢˜ï¼Œä¹‹æ‰€ä»¥å‰æ®µæ—¶é—´çªç„¶ç ”ç©¶äº†ä¸€ä¸‹ Socket ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„ä¸œè¥¿ï¼Œæ˜¯é‡åˆ°è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼šä¸€ä¸ªè¿›ç¨‹å°†è‡ªå·±çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªè¿›ç¨‹ç›¸åº”çš„ä½ç½®ã€‚å¸¦ç€å¯¹ Unix Domain Socket çš„æœ¦èƒ§è®¤è¯†ï¼Œå†™äº†ä¸€ä¸ªç®€å•çš„å®ç°åŸå‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// outlet.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_NAME &#34;/tmp/connection-uds-fd&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">make_connection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">connection_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">sun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sun</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sun</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">connection_fd</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">connection_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">send_fds</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket_fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="nf">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">io</span><span class="p">))];</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span> <span class="o">=</span> <span class="nf">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="nf">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">io</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_SOCKET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">SCM_RIGHTS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="nf">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">),</span> <span class="n">io</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="nf">sendmsg</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// printf(&#34;%d %d\n&#34;, size, errno);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">connection_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;write from outlet</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">connection_fd</span> <span class="o">=</span> <span class="nf">make_connection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">send_fds</span><span class="p">(</span><span class="n">connection_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// inner.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_NAME &#34;/tmp/connection-uds-fd&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">connect_socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">sun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fd</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sun</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sun</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sun</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sun</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">receive_fds</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket_fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="nf">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">))];</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span>    <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span>             <span class="o">=</span> <span class="nf">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span>   <span class="o">=</span> <span class="nf">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_SOCKET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span>  <span class="o">=</span> <span class="n">SCM_RIGHTS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="nf">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">),</span> <span class="n">fds</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="nf">recvmsg</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// printf(&#34;%d \n&#34;, size);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">fds</span><span class="p">,</span> <span class="nf">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d %d %d&#34;</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fds</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">msg_buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strcpy</span><span class="p">(</span><span class="n">msg_buf</span><span class="p">,</span> <span class="s">&#34;write from inner</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msg_buf</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">msg_buf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">socket_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fds</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">socket_fd</span> <span class="o">=</span> <span class="nf">connect_socket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">receive_fds</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œoutlet æ˜¯â€œè´¡çŒ®â€æ ‡å‡†è¾“å…¥è¾“å‡ºçš„è¿›ç¨‹ï¼Œinner æ˜¯â€œæŠ¢å â€ outlet æ ‡å‡†è¾“å…¥è¾“å‡ºçš„è¿›ç¨‹ã€‚æ•´ä½“ä¸Šä»£ç è¿˜æ¯”è¾ƒå¥½ç†è§£ï¼Œåªæ˜¯å¦‚æœéœ€è¦å‘æ–‡æ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦æ³¨æ„ <code>send_fds</code> å‡½æ•°ä¸­ <code>cmsg-&gt;cmsg_type = SCM_RIGHTS;</code> ä¸€è¡Œï¼Œå¿…é¡»åˆ¶å®š <code>cmsg_type</code> ä¸º <code>SCM_RIGHTS</code>ã€‚</p>
<p>åˆ†åˆ«ç¼–è¯‘ä¸¤ä¸ªç¨‹åºæ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gcc -o outlet outlet.c
</span></span><span class="line"><span class="cl">$ gcc -o inner inner.c
</span></span></code></pre></div><p>å…ˆæ‰§è¡Œ outletï¼Œå…ˆè¾“å‡º â€œwrite from outletâ€ åé˜»å¡ï¼Œç­‰å¾… inner è¿›ç¨‹çš„è¿æ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./outlet 
</span></span><span class="line"><span class="cl">$ write from outlet
</span></span></code></pre></div><p>ç„¶åå†å¯åŠ¨ inner è¿›ç¨‹ï¼Œinner è¿›ç¨‹è¾“å‡ºâ€œ4 5 6â€ï¼Œå¹¶åœ¨ outlet çš„æ ‡å‡†è¾“å‡ºè¾“å‡º â€œwrite from innerâ€œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./inner
</span></span><span class="line"><span class="cl">$ <span class="m">4</span> <span class="m">5</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl">$ 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./outlet
</span></span><span class="line"><span class="cl">$ write from outlet
</span></span><span class="line"><span class="cl">$ write from inner
</span></span></code></pre></div><p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ã€‚</p>
<p>inner ä¹‹æ‰€ä»¥è¾“å‡º â€4 5 6â€œ æ˜¯æ¯”è¾ƒå¥½å¥‡ä¼ é€’è¿‡æ¥çš„æ–‡ä»¶æè¿°ç¬¦åˆ°åº•æ˜¯é•¿å•¥æ ·çš„ï¼Œè¿™è¡Œæ‰“å°çœ‹ä»£ç å¯ä»¥çŸ¥é“æ˜¯æ‰“å°äº†æ¥æ”¶åˆ°çš„æ–‡ä»¶æè¿°ç¬¦çš„å€¼ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºäº†å‡ ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ä¹ˆâ€”â€”å°±åƒä¾¦æ¢æ¨ç†ä¸€æ ·ï¼Œæ²¡æœ‰æ­å¼€è°œåº•å‰å„ç§å¥½å¥‡ï¼Œä¸€æ—¦æ­å¼€è°œåº•äº†åå€’è¶£å‘³å…¨æ— äº†ã€‚</p>
<blockquote>
<p>P.S.  <a href="http://man7.org/linux/man-pages/man7/unix.7.html"  class="external-link" target="_blank" rel="noopener">unix(7)</a> ä¸­å…¶å®äº¤ä»£äº†ä¼ é€’æ–‡ä»¶æè¿°ç¬¦çš„æ•ˆæœè·Ÿ dup2 å·®ä¸å¤šçš„ï¼Œè¿˜æ€ªè‡ªå·±å¹³å¸¸æ²¡æœ‰å¥½å¥½ RTFM å•Šï¼š</p>
<pre tabindex="0"><code>SCM_RIGHTS
              Send or receive a set of open file descriptors from another
              process.  The data portion contains an integer array of the
              file descriptors.  The passed file descriptors behave as
              though they have been created with dup(2).
</code></pre></blockquote>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
      2019 -
    
    2024
     Hualet Wang 
    Â·
    
     <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  



  

  

  

  

  

  

  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121092907-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-121092907-1');
</script>


  

  

  

  

  

  

  
</body>

</html>
